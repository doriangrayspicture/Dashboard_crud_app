{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="card shadow p-4 mb-4">
  <h4 class="mb-3">Dashboard</h4>

  <!-- Date Range Form -->
  <form method="POST" class="mb-3">
    <div class="row g-3">
      <div class="col-md-4">
        <label for="start_date" class="form-label">Start Date</label>
        <input type="date" class="form-control" id="start_date" name="start_date" required>
      </div>
      <div class="col-md-4">
        <label for="end_date" class="form-label">End Date</label>
        <input type="date" class="form-control" id="end_date" name="end_date" required>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" name="date_range" class="btn btn-primary w-100">Search</button>
      </div>
    </div>
  </form>
  <form action="{{ url_for('dashboard') }}" method="GET" class="mt-3">
    <input type="hidden" name="view_all" value="1">
    <button type="submit" class="btn btn-info">View All Data</button>
  </form>
  <script>
document.addEventListener("DOMContentLoaded", function() {
  const form = document.querySelector("form[method='POST']");
  const startInput = document.getElementById("start_date");
  const endInput = document.getElementById("end_date");

  form.addEventListener("submit", function(event) {
    const startDate = new Date(startInput.value);
    const endDate = new Date(endInput.value);

    if (endDate <= startDate) {
      alert("End Date must be after Start Date.");
      event.preventDefault();
      return;
    }

    // Difference in days
    const diffDays = (endDate - startDate) / (1000 * 60 * 60 * 24);

    if (diffDays > 10) {
      alert("Date range cannot exceed 10 days.");
      event.preventDefault();
      return;
    }
  });
});
</script>



  {% if table %}
  <div class="table-responsive" style="max-height: 500px; overflow: auto;">
    <table id="dashboardTable" class="table table-bordered text-center align-middle">
      <thead class="table-dark">
        <tr>
          <th rowspan="2">Particular</th>
          {% for d in table.dates %}
            <th colspan="2">{{ d }}</th>
          {% endfor %}
        </tr>
        <tr>
          {% for d in table.dates %}
            <th>MU</th>
            <th>Rate</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for p in table.particulars %}
        <tr>
          <td><strong>{{ p }}</strong></td>
          {% for d in table.dates %}
            <td>{{ table.data[p][d].mu }}</td>
            <td>{{ table.data[p][d].rate }}</td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination controls -->
  <div class="d-flex justify-content-between mt-2">
    <button class="btn btn-sm btn-secondary" id="prevPage">Previous</button>
    <span id="pageInfo" class="align-self-center"></span>
    <button class="btn btn-sm btn-secondary" id="nextPage">Next</button>
  </div>

  <!-- Export button -->
  <form action="{{ url_for('export') }}" method="POST" class="mt-3">
    <button type="submit" class="btn btn-success">Export</button>
  </form>
  {% else %}
    <p class="text-muted">No records found for this range.</p>
  {% endif %}
</div>






<!-- Pagination JS -->
<div class="card shadow p-4">
  <h4 class="mb-3">Moving Average</h4>

  <!-- COMBINED FORM FOR MOVING AVERAGE -->
  <form method="POST" class="mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label for="moving_avg_days" class="form-label">Select Window</label>
        <select name="moving_avg_days" id="moving_avg_days" class="form-select">
          <option value="3" {% if selected_window == 3 %}selected{% endif %}>3 days</option>
          <option value="5" {% if selected_window == 5 %}selected{% endif %}>5 days</option>
          <option value="7" {% if selected_window == 7 %}selected{% endif %}>7 days</option>
          <option value="15" {% if selected_window == 15 %}selected{% endif %}>15 days</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="date" class="form-label">Select Date</label>
        <input type="date" class="form-control" id="date" name="date" required value="{{ selected_date or '' }}">
      </div>
      <div class="col-md-2">
        <button type="submit" name="moving_avg" class="btn btn-primary w-100">Fetch</button>
      </div>
    </div>
  </form>

  {% if average_data %}
  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle">
      <thead class="table-dark">
        <tr>
          <th>Particular</th>
          <th>MU AVG</th>
          <th>Rate AVG</th>
        </tr>
      </thead>
      <tbody>
        {% for particular, values in average_data.items() %}
        <tr>
          <td><strong>{{ particular }}</strong></td>
          <td>{{ '%.2f'|format(values.mu_avg) if values.mu_avg is not none else 'N/A' }}</td>
          <td>{{ '%.2f'|format(values.rate_avg) if values.rate_avg is not none else 'N/A' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% elif request.form.get("moving_avg") %}
    <p class="text-muted">No moving average data could be calculated for the selected date. (There might be insufficient previous data).</p>
  {% endif %}

  {% if missing_dates %}
  <div class="alert alert-warning mt-3" role="alert">
    <strong>Warning:</strong> Data for the following dates is not available:
    <ul>
      {% for date in missing_dates %}
      <li>{{ date }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
</div>

{% if session.get('role') == 'admin' %}
<div class="card shadow p-4 mt-4">
  <h4 class="mb-3">Activity Log</h4>
  <p>Logs count: {{ logs|length }}</p>


  {% if logs %}
  <div class="table-responsive" style="max-height:400px; overflow-y:auto;">

    <table id="logTable" class="table table-bordered text-center align-middle">
      <thead class="table-dark">
        <tr>
          <th>Log ID</th>
          <th>Username</th>
          <th>Action</th>
          <th>Details</th>
          <th>DateTime</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr>
          <td>{{ log.logid }}</td>
          <td>{{ log.username }}</td>
          <td>{{ log.action }}</td>
          <td>{{ log.details }}</td>
          <td>{{ log.datetime }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p class="text-muted">No activity logs found.</p>
  {% endif %}
</div>
{% endif %}

<script>
function filterLogs() {
  var filter = document.getElementById("filter").value;
  var rows = document.querySelectorAll("#logTable tbody tr");
  rows.forEach(row => {
    var action = row.cells[2].innerText;
    row.style.display = (filter === "" || action === filter) ? "" : "none";
  });
}

// Sort by column
function sortTable(colIndex) {
  var table = document.getElementById("logTable");
  var rows = Array.from(table.rows).slice(1);
  var sorted = rows.sort((a, b) =>
    a.cells[colIndex].innerText.localeCompare(b.cells[colIndex].innerText)
  );
  var tbody = table.tBodies[0];
  tbody.innerHTML = "";
  sorted.forEach(r => tbody.appendChild(r));
}
</script>
{% endblock %}
